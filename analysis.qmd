---
title: Analysis
author: "Team 6"
description: Here we provide a detailed analysis using more sophisticated statistics techniques.
toc: true
draft: false
---

![](images/nypd_analysis_page.jpeg)

```{r imports, echo=FALSE, message=FALSE, warning=FALSE}
# Load necessary libraries
library(tidyverse)
library(ggplot2)
#library(ggcorrplot) 
#library(GGally) 
library(readr)
library(dplyr)
library(lubridate)
library(sf)

# Read the dataset
data <- readRDS("dataset/nypd_shooting_clean.rds")
NYPD_arrest_data <- readRDS("dataset/nypd_arrest.rds")
combined_df <- merge(data, NYPD_arrest_data, by = c("X_COORD_CD", "Y_COORD_CD","Latitude","Longitude","PERP_SEX","JURISDICTION_CODE","PERP_RACE"))
nypd_payroll <- readRDS("dataset/nypd_payroll.rds")
nypd_payroll <- nypd_payroll %>%
  rename(
    work_boro = `Work Location Borough`,
    base_salary = `Base Salary`)
average_salary_by_borough <- nypd_payroll %>%
  group_by(work_boro) %>%
  summarise(AverageSalary = mean(base_salary, na.rm = TRUE)) %>%
  ungroup()  # Ensure that we remove the grouping structure

```


# Section 1: Deep-Dive Analysis and Motivation

Our team decided to use this dataset to understand regional differences in shooting crime rates and the boroughs in which they occur, reflecting the complex dynamics in urban socioeconomic and racial landscapes. The dataset provides a detailed view of the patterns and context in which crime occurs, allowing for more targeted prevention approaches. By analyzing perpetrator and victim demographics as well as specific characteristics of crime locations, the project identifies potential trends and potential hotspots of criminal activity. This in-depth analysis helps develop specialized interventions that are more likely to be effective in specific communities, ultimately helping to reduce crime and enhance public safety.

The most informative variables for the analysis include:

- Perpetrator Race
- Perpetrator Age Group
- Victim Race
- Victim Age Group
- Crime Location Classification
- Murder Rate
- Offense Description

**In search of deeper insights, the analysis seeks answers to the following questions:**

- What are the predominant racial demographics among perpetrators and victims?
<!-- - Which crime location classifications witness the highest frequency of criminal activity? -->
- Are there discernible patterns in murder rates across NYC boroughs?
- How do these variables collectively contribute to predicting the borough in which a crime occurs?
- With these questions in mind, we embark on a journey through exploratory data analysis and statistical modeling to uncover meaningful insights into crime dynamics within NYC.

## Section 1.1: Perpetrator Information
<!-- ### Section 1.1.1: Perpetrator Race -->

Given the proportional distribution of perpetrator race by borough, it is clear that the proportions of each race appear to vary across boroughs, suggesting differences in the racial distribution of perpetrators across New York City. Digging into each borough, the majority racial group among perpetrators is Black, followed by significant proportions of White Hispanics. Asian/Pacific Islander groups make up a relatively small share of perpetrators in each borough. Analysis across offender ethnicity and boroughs helps to understand crime-related demographic patterns in different urban areas, which is critical for targeted social and policing policies.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
boro_race1 <- combined_df |>
  count(BORO, PERP_RACE) |>
  group_by(BORO) |>
  mutate(percentage = n / sum(n) * 100)

ggplot(boro_race1, aes(x = BORO, y = percentage, fill = PERP_RACE)) + 
  geom_bar(stat = "identity", position = "fill") +
  theme_minimal() +
  labs(title = "Proportional Distribution of Perpetrator Race by Borough",
       x = "Borough",
       y = "Percentage",
       fill = "Perpetrator Race") +
  scale_y_continuous(labels = scales::percent_format())
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

<!-- ### Section 1.1.2: Relationship between Borough and Perpetrator Age -->

<!-- The bar chart illustrates the distribution of perpetrators by age group across different boroughs of New York City. It seems that Brooklyn and the Bronx have the highest counts of perpetrators across all age groups, with those aged 25-44 being the most numerous in these areas. Manhattan follows, displaying a similar pattern with the 25-44 age group being predominant. Queens and Staten Island have significantly lower counts of perpetrators, but the same trend persists where individuals aged 25-44 are the most represented. The least number of perpetrators are those aged 65 and above, which is consistent across all boroughs. The chart suggests that middle-aged adults (25-44) are the most common age group for perpetrators in the city, and that there is a considerable variance in the number of perpetrators between the boroughs, with Brooklyn and the Bronx being the most affected. -->

<!-- ```{r, echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- perp_age_counts <- combined_df %>% -->
<!--   count(BORO, PERP_AGE_GROUP) %>% -->
<!--   arrange(BORO, desc(n)) -->
<!--  -->
<!-- ggplot(perp_age_counts, aes(x = BORO, y = n, fill = PERP_AGE_GROUP)) + -->
<!--   geom_bar(stat = "identity", position = "stack") +  -->
<!--   theme_minimal() + -->
<!--   labs(title = "Relationship between Borough and Perpetrator Age", -->
<!--        x = "Borough", -->
<!--        y = "Count", -->
<!--        fill = "Perpetrator Age Group") -->
<!-- ``` -->

## Section 1.2: Victim Information
<!-- ### Section 1.2.1: Victim Race -->

Based on the proportional distribution of victim race by borough, it is evident that the proportions of each race appear to vary across boroughs, suggesting differences in the racial distribution of victims across New York City. The racial distribution of victims is more dispersed compared to the racial distribution of perpetrators across boroughs. The victim race can be a crucial factor in understanding and predicting crime in different boroughs of New York City, as it might reflect underlying patterns of victimization related to social, economic, and possibly racial dynamics within these areas.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
boro_race2 <- combined_df |>
  count(BORO, VIC_RACE) |>
  group_by(BORO) |>
  mutate(percentage = n / sum(n) * 100)

ggplot(boro_race2, aes(x = BORO, y = percentage, fill = VIC_RACE)) + 
  geom_bar(stat = "identity", position = "fill") +
  theme_minimal() +
  labs(title = "Proportional Distribution of Victim Race by Borough",
       x = "Borough",
       y = "Percentage",
       fill = "Victim Race") +
  scale_y_continuous(labels = scales::percent_format())
```

<!-- ### Section 1.2.2: Victim Age Group -->

<!-- The stacked bar chart illustrates the relationship between various New York City boroughs and the age groups of crime victims. Manhattan appears to have the highest total count of victims across all age groups, followed closely by Brooklyn. Both boroughs show a particularly high prevalence of victims aged 25-44. The Bronx also shows a significant number of victims, especially in the 25-44 and 45-64 age categories. Queens and Staten Island have a lower total count of victims, but similar patterns in age distribution can be observed, with the majority of victims falling into the 25-44 age group. The age group '65+' has the lowest count across all boroughs, and there is a notable number of cases where the victim's age is unknown. This visualization can provide insights into which age groups are more affected by crime in specific boroughs, which can be valuable for targeted policy-making and resource allocation. -->

<!-- ```{r, echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- age_boro_count2 <- combined_df %>% -->
<!--   count(BORO, VIC_AGE_GROUP) %>% -->
<!--   arrange(BORO, desc(n)) -->

<!-- ggplot(age_boro_count2, aes(x = BORO, y = n, fill = VIC_AGE_GROUP)) + -->
<!--   geom_bar(stat = "identity", position = "stack") +  -->
<!--   theme_minimal() + -->
<!--   labs(title = "Relationship between Borough and Victim Age", -->
<!--        x = "Borough", -->
<!--        y = "Count", -->
<!--        fill = "Victim Age Group") -->
<!-- ``` -->

<!-- ## Section 1.3: Crime Location Classification -->

<!-- This bar chart displays the distribution of crime location classifications. The majority of crimes are classified under "Street", indicating that this is the most common location for crime in the dataset, with a significantly higher count compared to other categories. "Dwelling" and "Housing" also appear to be relatively common crime locations, with "Housing" showing a notably higher count than "Dwelling". The chart provides a clear visual summary of where crimes tend to occur, which could be used by law enforcement and city planners to allocate resources more effectively. -->

<!-- # ```{r, echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- # # Perpetrator and Victim Demographics: Age Group Distribution -->
<!-- # loc_counts <- data |> -->
<!-- #   count(LOC_CLASSFCTN_DESC) |> -->
<!-- #   arrange(desc(n)) -->
<!-- #  -->
<!-- # ggplot(loc_counts, aes(x = reorder(LOC_CLASSFCTN_DESC, -n), y = n, fill = LOC_CLASSFCTN_DESC)) + -->
<!-- #   geom_bar(stat = "identity") + -->
<!-- #   theme_minimal() + -->
<!-- #   labs(title = 'Crime Location Classification Distribution', x = 'Crime Location Classification', y = 'Count', fill = "Location Classification") + -->
<!-- #   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") -->
<!-- # ``` -->

## Section 1.3: Average Salary by NYC Borough 

The map explore the average salary distribution across the five boroughs of New York City (NYC). Utilizing a map, the plot highlights spatial variations in average salary levels across different boroughs, with color intensity indicating salary magnitudes. This spatial perspective offers valuable insights into geographic disparities in salary distribution within NYC, providing a comprehensive understanding of economic dynamics across its diverse neighborhoods. It is easy to visualize the disparity of income levels in NYC, such as the vast disparity between the Borough Brooklyn and Manhattan.

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}

shapefile_path <- "tl_2022_36_tract/tl_2022_36_tract.shp"
complete_data <- st_read(shapefile_path)

nyc_tracts <- complete_data |> 
  filter(COUNTYFP %in% c("005", "047", "061", "081", "085"))

nypd_payroll <- readRDS("dataset/nypd_payroll.rds")
nypd_payroll <- nypd_payroll %>%
  rename(
    work_boro = `Work Location Borough`,
    base_salary = `Base Salary`)

average_salary_by_borough <- nypd_payroll %>%
  group_by(work_boro) %>%
  summarise(AverageSalary = mean(base_salary, na.rm = TRUE)) %>%
  ungroup()

# ggplot(average_salary_by_borough, aes(x = work_boro, y = AverageSalary, fill = work_boro)) +
#   geom_col(position = "dodge") +
#   theme_minimal() +
#   labs(title = "Average Salary by Work Location Borough", x = "Work Location Borough", y = "Average Salary") +
#   guides(fill = FALSE)

# Calculate average salary by borough
average_salary_by_borough <- nypd_payroll %>%
  group_by(work_boro) %>%
  summarise(AverageSalary = mean(base_salary, na.rm = TRUE)) %>%
  ungroup()

borough_to_fips <- data.frame(
  work_boro = c("BRONX", "BROOKLYN", "MANHATTAN", "QUEENS", "OTHER"),  # Note: Ensure the names match the data
  COUNTYFP = c("005", "047", "061", "081", "085"))

average_salary_by_fips <- average_salary_by_borough %>%
  left_join(borough_to_fips, by = "work_boro")
average_salary_by_fips <- average_salary_by_fips %>%
  select(COUNTYFP, AverageSalary)

# map Average Salary by NYC Borough
nyc_tracts_salary <- nyc_tracts %>%
  left_join(average_salary_by_fips, by = "COUNTYFP")
# Plot the map with average salaries indicated by color
ggplot(nyc_tracts_salary) +
  geom_sf(aes(fill = AverageSalary), color = "gray", size = 0.5) +
  scale_fill_gradient(low = "white", high = "deepskyblue4", name = "Avg Salary",
                      na.value = "grey50", labels = scales::dollar_format()) +
  labs(title = "Average Salary by NYC Borough",
       subtitle = "Color intensity indicates average salary levels",
       fill = "Average Salary") +
  theme_minimal() +
  theme(legend.position = "right")
```

## Section 1.4: Murder Rate

The bar chart illustrates the murder rates as percentages for each borough. It's noticeable that the Bronx and Staten Island exhibit the highest murder rates. The murder rate is a significant indicator because it reflects the frequency of violent crimes within a community. Understanding the murder rate is vital for predicting where shooting crime incidents are more likely to occur, which in turn is essential for prioritizing law enforcement resources, improving public safety measures, and implementing preventative programs. High murder rates in certain boroughs might suggest the need for increased police presence and other interventions aimed at violence reduction. Conversely, boroughs with lower rates can provide which policies or social structures may be contributing to a safer environment. Understanding these patterns are critical steps towards effective crime prevention and ensuring the safety and well-being of the residents.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
murder_rate <- combined_df %>%
  group_by(BORO) %>%
  summarise(
    total_cases = n(),
    murder_cases = sum(STATISTICAL_MURDER_FLAG == TRUE, na.rm = TRUE),
    murder_rate = murder_cases / total_cases * 100
  )


ggplot(data = murder_rate, aes(x = reorder(BORO, -murder_rate), y = murder_rate, fill = BORO)) +
  geom_bar(stat = "identity", width = 0.6) +
  theme_minimal() +
  labs(title = "Murder Rate by Borough",
       x = "Borough",
       y = "Murder Rate (%)") +
  theme(legend.position = "none")
```
# Section 2: Statistical Models

The analytical model was designed to examine if the thesis and model were related to each other and predict the shooting crimes would occur in which borough based on several predictors: 

For the predictors, they first be converted from characters into factors as statistical models require categorical variables encoded as factors. The independent variables include: Perpetrator Sex, Perpetrator Race, Location, Perpetrator age group, Victim Sex, Victim Age group, Victim Race, Offense Description, and Murder Flag.

These choices were driven by their potential to capture key aspects of crime patterns and dynamics within the city. Demographic characteristics of both perpetrators and victims, along with the type and location of offenses, provide valuable insights into crime commission and victimization patterns. By exploring these variables and their relationships with the borough where the crime occurs, correlations were identified that suggest their relevance as predictors.

## Section 2.1: Multinomial Regression Model

The first model is the Multinomial Logistic Regression since the model needs to account for the fact that the target variable (Borough) has 5 classes. However, the model only gave an accuracy of **56%**, which does not meet the expectation. The confusion matrix is listed below to visualize the performance of this model. Because the distribution of shooting crime incidents in each borough from the dataset is uneven, this limitation of the dataset makes the 56% accuracy even more unsatisfactory for the prediction model as shown in the confusion matrix.

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(nnet)
library(caret)

modeldata <- combined_df %>%
  mutate(across(where(is.character), as.factor))

freq <- table(modeldata$OFNS_DESC)
modeldata <- modeldata[modeldata$OFNS_DESC %in% names(freq[freq >= 200]), ]

set.seed(123)
train_indices <- sample(1:nrow(modeldata), 0.8 * nrow(modeldata))  # 80% for training
train_data <- modeldata[train_indices, ]
test_data <- modeldata[-train_indices, ]

model1 <- multinom(BORO ~ LOC_CLASSFCTN_DESC + PERP_RACE + PERP_AGE_GROUP + VIC_AGE_GROUP + VIC_RACE + OFNS_DESC + STATISTICAL_MURDER_FLAG, data = train_data)

predictions <- predict(model1, test_data)

accuracy <- mean(predictions == test_data$BORO)
```
```{r , echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(knitr)

conf_matrix <- confusionMatrix(as.factor(predictions), as.factor(test_data$BORO))

kable(conf_matrix$table, caption = "Confusion Matrix")
```

```{r , echo=FALSE, message=FALSE, warning=FALSE}
kable(conf_matrix$table, caption = "Confusion Matrix")
# print(paste("Accuracy %:", accuracy*100))
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
modeldata2 <- combined_df |>
  mutate(across(where(is.character), as.factor)) |>
  filter(OFNS_DESC %in% names(which(table(OFNS_DESC) >= 200))) |>
  filter(BORO != "STATEN ISLAND") |>
  mutate(BORO = factor(BORO, levels = unique(BORO)))

set.seed(123)
train_indices2 <- sample(1:nrow(modeldata2), 0.8 * nrow(modeldata2)) 
train_data2 <- modeldata2[train_indices2, ]
test_data2 <- modeldata2[-train_indices2, ]

test_data2$BORO <- factor(test_data2$BORO, levels = levels(train_data2$BORO))

model2 <- multinom(BORO ~ LOC_CLASSFCTN_DESC + PERP_RACE + PERP_AGE_GROUP + VIC_AGE_GROUP + VIC_RACE + OFNS_DESC + STATISTICAL_MURDER_FLAG, data = train_data2)

predictions2 <- predict(model2, test_data2)
accuracy2 <- mean(predictions2 == test_data2$BORO)

# conf_matrix2 <- confusionMatrix(as.factor(predictions2), as.factor(test_data2$BORO))
# kable(conf_matrix2$table, caption = "Confusion Matrix2")
```

```{r , echo=FALSE, message=FALSE, warning=FALSE}
print(paste("Accuracy % (without Staten Island):", accuracy2*100))
```

To potentially improve model performance, the model was reproduced by removing the Staten Island observations. First, Staten Island has very few data points compared to other boroughs, which may result in lack of representation of this category. Such a small sample size may not accurately capture the characteristics of Staten Island, resulting in biased predictions that do not generalize well to new data. By excluding Staten Island, the model can focus more on relationships and patterns in larger data sets from other boroughs, potentially improving the model's overall predictive accuracy and robustness. After filtered the data, the model gave an accuracy of **63%**, which is slightly better than before. However, since the purpose of the model is to better help the NYPD prevent such incidents and allocate resources by predicting the occurrence of shooting crime incidents, a higher accuracy rate is needed to maximize the performance of the model.

## Section 2.2: Random Forest

The second statistical model is the Random Forest model. Using a random forest model to predict data for all boroughs, including Staten Island, has advantages due to its inherent robustness and flexibility. This model can reduce the impact of noise in any single subset of data. Additionally, Random Forest can handle imbalanced data and maintain accuracy, such as Staten Island, allowing for a comprehensive and inclusive predictive analysis in this diverse and uneven dataset.

The same training and testing data were applied to the random forest to ensure that the results of the model were meaningful. The significance of creating this model is to consider that this model can accommodate the constraint of uneven distribution of data in each borough. However, the Random Forest model is difficult to visualize, which is an inevitable limitation.

```{r , echo=FALSE, message=FALSE, warning=FALSE}
library(randomForest)

rf_model <- randomForest(BORO ~ PERP_SEX + PERP_RACE + LOC_CLASSFCTN_DESC + PERP_AGE_GROUP + VIC_SEX + VIC_AGE_GROUP + VIC_RACE + OFNS_DESC + STATISTICAL_MURDER_FLAG, 
                         data = train_data, 
                         ntree = 500,
                         importance = TRUE,
                         na.action = na.omit)
plot(rf_model)
```

```{r , echo=FALSE, message=FALSE, warning=FALSE}
test_pred <- predict(rf_model, test_data)
conf_mat <- table(test_data$BORO, test_pred)
accuracy <- sum(diag(conf_mat)) / sum(conf_mat)
print(paste("Accuracy %:", accuracy*100))
```

This plot shows the error rate of the Random Forest model decreases as the number of trees increases. Each line in the plot represents the error for a different type of prediction task. Under this model, those different lines represent the error rate for various classes within the target variable (Borough).

Random forest gives an accuracy of **83%** which is much better. However, due to the data having most of the crimes in a small subset of the boroughs, the model is biased and does not have sufficient data for the other boroughs like Staten Island to predict it. It is also impossible to predict exactly because of the many variables that need to be considered for completely accurate predictions. Under this model, the three variables with the highest importance are Offense Type, Victim Race, and Crime location classification.

An accuracy of 84% is still good however to show that these variables do in fact impact which Borough the crime takes place in and these Boroughs have income levels correlated with them as we can see in Section 1.3 above.

# Section 3: Limitations and Constraints in Geographic and Variable Diversity 

In analyzing data specific to New York City, it's crucial to recognize the limitations this imposes when attempting to generalize findings to other regions or populations. The data's geographical constraint to NYC means the insights derived are most valid within this specific context. This is not inherently a bias but rather a limitation on the scope of the conclusions. The variables, behaviors, and trends observed in the NYC dataset may not be representative of other areas due to differences in demographics, legal systems, cultural norms, and crime patterns. Therefore, while this dataset provides valuable insights into crime dynamics within NYC, extrapolating these findings to a broader context without additional data from other regions would lead to inaccurate conclusions and potentially misleading policy recommendations.

Furthermore, the model used in the analysis relies solely on categorical variables, including location classification, perpetrator race, perpetrator age group, victim age group, victim race, offense description, and murder flags. This reliance on categorical data limits the analytical depth and complexity that could be achieved with a combination of categorical and continuous variables. For instance, continuous variables could provide detailed insights into the timing of crimes, distances between crime locations, or economic factors, which might significantly influence crime patterns. Additionally, the model's current structure may not capture interactions between variables or nonlinear relationships, which are often critical in understanding complex social phenomena like crime. Incorporating more diverse data types and expanding the model to include interaction terms or polynomial components could enhance its predictive power and provide a more comprehensive understanding of the factors influencing crime in NYC.



